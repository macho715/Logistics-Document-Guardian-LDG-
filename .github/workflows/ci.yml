name: CI

on: [push, pull_request]

jobs:
  test:
    name: ğŸ§ª Lint â€¢ Type â€¢ Test
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest]
        python-version: ["3.11"]
    steps:
    # 1) ì†ŒìŠ¤ ì²´í¬ì•„ì›ƒ
    - uses: actions/checkout@v4

    # DEBUG: List files after checkout
    - name: ğŸ› List files in workspace
      run: |
        echo "--- Files in workspace root (Linux) ---"
        ls -la
        echo "--- Files in workspace root (Windows) ---"
        dir
      shell: bash

    # 2) Python ì„¤ì¹˜ (GitHub ì œê³µ íˆ´ìºì‹œ í™œìš©)
    - name: â¬‡ï¸ Setup Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: "pip"             # pip ìºì‹œ í™œì„±í™”
        cache-dependency-path: requirements.lock # Explicitly point to the lock file

    # 3) OSâ€‘ë³„ Tesseract ì„¤ì¹˜
    - name: ğŸ› ï¸ Install Tesseract (Windows)
      if: runner.os == 'Windows'
      run: powershell -ExecutionPolicy Bypass -File scripts/install_tesseract_win.ps1

    - name: ğŸ› ï¸ Install Tesseract (Ubuntu)
      if: runner.os == 'Linux'
      run: bash scripts/install_tesseract_apt.sh

    # 4) ì˜ì¡´ì„± ì„¤ì¹˜ (pipâ€‘tools ì ê¸ˆ)
    - name: ğŸ“¦ Install Python deps via pip-sync
      run: |
        python -m pip install -U pip pip-tools
        pip-sync requirements.lock
        # src íŒ¨í‚¤ì§€ëŠ” editable ì„¤ì¹˜ ìœ ì§€
        python -m pip install -e .

    # 5) Lint â€¢ Format â€¢ Type Check â€¢ Tests
    - name: ğŸ” Ruff & Black
      run: |
        ruff .
        black --check .

    - name: ğŸ” Mypy strict typing
      run: mypy .

    - name: ğŸ§ª Pytest
      run: pytest -q

    # 6) ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ (ì„ íƒ)
    # - name: Upload coverage
    #   uses: codecov/codecov-action@v4 