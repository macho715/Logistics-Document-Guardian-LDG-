name: CI

on: [push, pull_request]

jobs:
  win-test:
    name: ğŸ§ª Lint â€¢ Type â€¢ Test (Windows)
    runs-on: windows-latest
    # Removed strategy matrix as it's Windows only now

    steps:
    # 1) Checkout
    - uses: actions/checkout@v4

    # 2) List files (ë””ë²„ê·¸ìš©Â·ì„ íƒ) - Using cmd shell for dir
    - name: ğŸ“‚ List files
      run: dir
      shell: cmd

    # 3) List data/pdf
    - name: ğŸ” List data/pdf
      run: |
        echo "CI workspace: $(pwd)"
        echo "--- Listing data/pdf ---"
        ls -l data/pdf || echo "data/pdf directory not found or empty"
      shell: bash

    # 4) Setup Python
    - name: â¬‡ï¸ Setup Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: |
          pyproject.toml
          requirements.lock

    # 5) GCP Authentication
    - name: ğŸ—ï¸ Authenticate to Google Cloud
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    # 6) Python deps ì„¤ì¹˜ (Will install google-cloud-documentai via pip-sync)
    - name: ğŸ“¦ Install deps
      run: |
        python -m pip install -U pip
        python -m pip install pip-tools
        pip-sync requirements.lock
        python -m pip install -e .        # editable install

    # 7) Ruff Format & Lint (Auto-fix in CI)
    - name: ğŸ–‹ Ruff format (apply Black-style)
      run: ruff format .

    - name: ğŸ–‹ Ruff lint auto-fix -- ignore D401,E501
      # Force ignore specific rules directly in the CI command
      run: ruff check . --fix --ignore D401,E501

    - name: ğŸ” Ruff lint verify
      # Verification step should ideally also ignore the same rules if needed,
      # but let's start with just the --fix step.
      # Consider adding --ignore D401,E501 here too if verification fails.
      run: ruff check .           # Verify no issues remain after fix

    # 8) Mypy
    - name: ğŸ” Mypy strict typing
      # Run mypy only on src and tests directories to avoid duplicate module errors
      run: mypy src tests

    # 9) Pytest
    - name: ğŸ§ª Pytest
      run: pytest -q # Pytest should be configured in pyproject.toml to generate coverage
      env:
        GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID || secrets.GCP_PROJECT_ID }} # Use repo var or secret
        GCP_LOCATION: ${{ vars.GCP_LOCATION || 'us' }} # Use repo var or default
        GCP_PROCESSOR_ID: ${{ vars.GCP_PROCESSOR_ID || secrets.GCP_PROCESSOR_ID }} # Use repo var or secret
        # Ensure GOOGLE_APPLICATION_CREDENTIALS is set by google-github-actions/auth

    # 10) ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ (ì„ íƒ)
    - name: â¬†ï¸ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      # No token needed for public repositories on GitHub Actions
      # with:
      #   token: ${{ secrets.CODECOV_TOKEN }} # Only required for private repos

# End of job 